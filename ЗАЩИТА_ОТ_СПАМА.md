# Защита от спама

## Реализованные механизмы защиты

### 1. Лимит сообщений в минуту
- **Настройка**: `MAX_MESSAGES_PER_MINUTE = 10`
- **Описание**: Пользователь может отправить максимум 10 сообщений в течение одной минуты
- **Ошибка**: HTTP 429 Too Many Requests

### 2. Лимит сообщений в час
- **Настройка**: `MAX_MESSAGES_PER_HOUR = 50`
- **Описание**: Пользователь может отправить максимум 50 сообщений в течение одного часа
- **Ошибка**: HTTP 429 Too Many Requests

### 3. Минимальный интервал между сообщениями
- **Настройка**: `MIN_SECONDS_BETWEEN_MESSAGES = 3`
- **Описание**: Между отправкой двух сообщений должно пройти минимум 3 секунды
- **Ошибка**: HTTP 429 Too Many Requests

### 4. Защита от дубликатов
- **Настройка**: `DUPLICATE_MESSAGE_WINDOW_SECONDS = 300` (5 минут)
- **Описание**: Пользователь не может отправить идентичное сообщение (с тем же subject, body и recipient_id) в течение 5 минут
- **Ошибка**: HTTP 400 Bad Request

### 5. Защита от отправки самому себе
- **Описание**: Пользователь не может отправить сообщение самому себе
- **Ошибка**: HTTP 400 Bad Request

## Расположение кода

Защита от спама реализована в:
- `app/services/message_service.py` - метод `_check_spam_protection()`
- `app/core/config.py` - настройки лимитов

## Настройка лимитов

Лимиты можно настроить через переменные окружения в файле `.env`:

```env
MAX_MESSAGES_PER_MINUTE=10
MAX_MESSAGES_PER_HOUR=50
MIN_SECONDS_BETWEEN_MESSAGES=3
DUPLICATE_MESSAGE_WINDOW_SECONDS=300
```

Или изменить значения по умолчанию в `app/core/config.py`.

## Тестирование

Все механизмы защиты протестированы:

### Unit тесты
- `tests/test_message_service.py`:
  - `test_create_message_spam_limit_per_minute` - лимит в минуту
  - `test_create_message_spam_limit_per_hour` - лимит в час
  - `test_create_message_min_interval_protection` - минимальный интервал
  - `test_create_message_duplicate_prevention` - защита от дубликатов
  - `test_create_message_to_self` - отправка самому себе

### Интеграционные тесты
- `tests/test_api_messages.py`:
  - `test_create_message_spam_protection_min_interval` - минимальный интервал через API
  - `test_create_message_spam_protection_limit_per_minute` - лимит в минуту через API
  - `test_create_message_duplicate_prevention` - дубликаты через API

## Примеры использования

### Пример 1: Превышение лимита в минуту

```python
# Пользователь отправляет 10 сообщений в течение минуты
for i in range(10):
    create_message(recipient_id=2, subject=f"Message {i}", body="Body")

# 11-е сообщение будет заблокировано
response = create_message(recipient_id=2, subject="Spam", body="Spam")
# HTTP 429 Too Many Requests
```

### Пример 2: Слишком частые сообщения

```python
# Отправляем сообщение
create_message(recipient_id=2, subject="First", body="Body")

# Сразу пытаемся отправить второе (менее 3 секунд)
create_message(recipient_id=2, subject="Second", body="Body")
# HTTP 429 Too Many Requests
```

### Пример 3: Дубликат сообщения

```python
# Отправляем сообщение
create_message(
    recipient_id=2,
    subject="Hello",
    body="Test message"
)

# В течение 5 минут пытаемся отправить то же самое
create_message(
    recipient_id=2,
    subject="Hello",
    body="Test message"
)
# HTTP 400 Bad Request
```

## Рекомендации

1. **Для продакшена**: Увеличьте `MAX_MESSAGES_PER_HOUR` для активных пользователей
2. **Для тестирования**: Уменьшите `MIN_SECONDS_BETWEEN_MESSAGES` для удобства
3. **Мониторинг**: Логируйте все случаи блокировки для анализа
4. **Настройка**: Адаптируйте лимиты под специфику вашей игры

## Будущие улучшения

Возможные дополнения:
- Rate limiting по IP адресу
- Временная блокировка аккаунта при частых нарушениях
- Белый список пользователей (VIP) с увеличенными лимитами
- Динамические лимиты на основе репутации пользователя

